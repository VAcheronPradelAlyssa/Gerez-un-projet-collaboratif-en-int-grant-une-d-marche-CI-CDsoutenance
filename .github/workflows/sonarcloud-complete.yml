name: SonarCloud Unified Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Backend (Java)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'
      
      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
      
      - name: Build Backend and Run Tests
        working-directory: ./back
        run: |
          # Copier les dÃ©pendances pour SonarCloud
          mvn dependency:copy-dependencies -DoutputDirectory=target/dependency
          # Build et tests avec couverture JaCoCo
          mvn clean verify
          echo "âœ… Backend build completed with coverage"

      # Frontend (Node.js)
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: front/package-lock.json
      
      - name: Install Frontend Dependencies
        working-directory: ./front
        run: npm ci
      
      - name: Run Frontend Tests with Coverage
        working-directory: ./front
        run: |
          npm run test:ci
          echo "âœ… Frontend tests completed with coverage"

      # Debug pour vÃ©rifier les fichiers
      - name: Verify Coverage Files
        run: |
          echo "=== Backend Coverage ==="
          ls -la back/target/site/jacoco/ || echo "âŒ No jacoco report"
          
          echo "=== Frontend Coverage ==="
          ls -la front/coverage/ || echo "âŒ No frontend coverage"
          
          echo "=== Dependencies ==="
          ls -la back/target/dependency/ || echo "âŒ No dependencies"

      # SonarCloud analysis avec nouveau projet
      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v5.0.0
        with:
          args: >
            -Dsonar.organization=vacheronpradelalyssa
            -Dsonar.projectKey=vacheronpradelalyssa_bobapp-complete
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Analysis Complete
        run: |
          echo "ðŸŽ‰ SonarCloud Analysis completed for BobApp Complete!"
          echo "ðŸ“Š Check results at: https://sonarcloud.io/project/overview?id=vacheronpradelalyssa_bobapp-complete"